<% content_for :heading do %>
	Attendance Records
<% end %>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBygb2VxPHEs8rV8j7dgreRvpowydmGrow&libraries=places" async defer></script>

<div class="container">
	<div class="col-sm-6 col-xs-6">
		<div class="form-group">
			<div class='input-group date' id='startDatetimepicker'>
				<input type='text' class="form-control" />
				<span class="input-group-addon">
					<i class="fa fa-calendar" aria-hidden="true"></i>								
				</span>
			</div>
		</div>
	</div>
	<div class="col-sm-6 col-xs-6">
		<div class="form-group">
			<div class='input-group date' id='endDatetimepicker'>
				<input type='text' class="form-control" />
				<span class="input-group-addon">
					<i class="fa fa-calendar" aria-hidden="true"></i>								
				</span>
			</div>
		</div>
	</div>
	<button onClick="fetchAttendanceData()"> Go </button>
</div>


	
<h3> Institute Attendance Summary    <%= params[:start_date].strftime("%b %d") %> - <%= params[:end_date].strftime("%b %d") %></h3> 
<% if(!@all_attendance_records.blank?) %>
	<div id="chart_div" style="max-width:400px;margin: 0 auto;">

	</div>
<% else %>
	Sorry! No records found !
<% end %>
<div class="form-group">
	<label for="sel1">Select Class:</label>
	<% options = [["Select Class", ""]] %>
	<% @all_section_member_models.each do |section_member_model| %>
		<% options << ["Class #{section_member_model.grade.grade_name}", section_member_model.grade.id] %>
	<% end %>
	<%= select_tag :grade_id, options_for_select(options, ["Class #{@grade.grade_name}", @grade.id]), id: "sel1" %>
</div>
<div class="form-group">
	<label for="sel2">Select Section:</label>
	<% options = [["Select Section", ""]] %>
	<% @all_section_member_models.each do |section_member_model| %>
		<% options << ["Section #{section_member_model.section.section_name}", section_member_model.section.id] %>
	<% end %>
	<%= select_tag :section_id, options_for_select(options, ["Section #{@section.section_name}", @section.id]), id: "sel2" %>
</div>
<button onClick="fetchAttendanceData()"> Go </button>

<h3>Class <%= @grade.grade_name %><%= @section.section_name %> Students Attendance   <%= params[:start_date].strftime("%b %d") %> - <%= params[:end_date].strftime("%b %d") %></h3>

<% if(!@section_attendance_records.blank?) %>
	<div id="chart_div_class" style="max-width:400px;margin: 0 auto;">
	
	</div>

	<div class="table-responsive">
		<table class="table">
			<thead>
			  	<tr>
			    	<th>Student</th>
		    		<% (@section_attendance_records.first.date..@section_attendance_records.last.date).to_a.each do |date| %>
		    			<th><%= date.strftime("%b %d") %></th>	
		    		<% end %>
			  	</tr>
			</thead>
			<tbody>
			  	<% @section_students.each do |student| %>
			  		<tr>
				    	<td><%= student.first_name %></td>
				    	<% (@section_attendance_records.first.date..@section_attendance_records.last.date).to_a.each do |date| %>
				    		<% date_attendance_record = @section_attendance_records.find_by(date: date) %>
				    		<% if(!date_attendance_record.blank? and date_attendance_record.present_student_ids.split(", ").include?(student.id.to_s)) %>
				    			<th class="info">Present</th>		
				    		<% else %>
				    			<th class="warning">Absent</th>		
				    		<% end %>
			    			
			    		<% end %>
				    
				  	</tr>
			  	<% end %>
			  	
			</tbody>
		</table>
	</div>
<% else %>
	Sorry ! No records found !
<% end %>

<script type="text/javascript">
	
	$('#startDatetimepicker, #endDatetimepicker').datetimepicker({
		defaultDate: new Date(),
        format: 'DD/MM/YYYY'
   	});

	google.charts.load('current', {'packages':['corechart']})
	<% if(!@all_attendance_records.blank?) %>
    	google.charts.setOnLoadCallback(drawChart);;
    <% end %>	
    
    <% if(!@section_attendance_records.blank?) %>
    	google.charts.setOnLoadCallback(drawClassChart);
    <% end %>
   
	function drawChart() {

		var data = new google.visualization.DataTable();
		data.addColumn('string', '');
		data.addColumn('number', '');
		<% if(@total_all_students > 0) %>
			data.addRows([
			  ['Present Students (in %)', <%= 100*@total_all_present_students/@total_all_students %>],
			  ['Absent Students (in %)', <%= 100*@total_all_absent_students/@total_all_students %>]
			]);
		<% else %>
			data.addRows([
			  ['Present Students (in %)', 0],
			  ['Absent Students (in %)', 0]
			]);
		<% end %>
		

		var options = {
			width: 400,
			height: 240,
			title: 'Institute Attendance Analytics',
			titlePosition: 'none',
			colors: ['#5dd4b7', '#ea5b31'],
			is3D: true
		};

		var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
		chart.draw(data, options);
	}

	function drawClassChart() {

		var data = new google.visualization.DataTable();
		data.addColumn('string', '');
		data.addColumn('number', '');

		<% if(@total_section_students > 0) %>
			data.addRows([
			  ['Present Students (in %)', <%= 100*@total_section_present_students/@total_section_students %>],
			  ['Absent Students (in %)', <%= 100*@total_section_absent_students/@total_section_students %>]
			]);
		<% else %>
			data.addRows([
			  ['Present Students (in %)', 0],
			  ['Absent Students (in %)', 0]
			]);
		<% end %>
		

		var options = {
			width: 400,
			height: 240,
			title: 'Class <%= @grade.grade_name %><%= @section.section_name %> Attendance',
			titlePosition: 'none',
			colors: ['#5dd4b7', '#ea5b31'],
			is3D: true
		};

		var chart = new google.visualization.PieChart(document.getElementById('chart_div_class'));
		chart.draw(data, options);
	}

	function fetchAttendanceData(){
		start_date = $('#startDatetimepicker').data('date');
		end_date = $('#endDatetimepicker').data('date');
		grade_id = $( "#sel1 option:selected" ).val();
		section_id = $( "#sel2 option:selected" ).val();

		Turbolinks.visit('/institutes/<%= @institute.id %>/attendance_records?start_date=' + start_date + '&end_date=' + end_date + '&grade_id=' + grade_id + '&section_id=' + section_id);
	}
</script>