<% if(!params[:page].blank? and !params[:message_category].blank? and params[:page].to_i >= 2) %>
	<% if(!instance_variable_get("@" + params[:message_category] +"_category_messages").blank?) %>
		<% instance_variable_get("@" + params[:message_category] +"_category_messages").each do |message| %>
			<%= render partial: "messages/message", locals: {conversation: @conversation, message: message} %>
		<% end %>
	<% end %>

<% else %>
	<div class="chat-show-full-wrapper conversation-big" data-conversation-id="<%= @conversation.id %>">
		<nav class="navbar navbar-inverse navbar-fixed-top main-app-header">
			<div class="container-fluid">
				<div class="navbar-header main-app-show-main-header pull-left">
					<div class="media pad-hor">
						<a class="mybtn btn btn-link btn-xs" href="/"><i class="material-icons">&#xE317;</i></a>
						<%= link_to edit_conversation_path(@conversation) do %>
							<div class="media-left media-middle">
								
									<img src="<%= @conversation.get_conversation_image_url_to_show_to_user(current_user, :thumb) %>" class="media-object img-circle img-sm" >
								
							</div>
							<div class="media-body media-middle chat-show-media">
								<h4 class="media-heading"> <%= @conversation.get_conversation_name_to_show_to_user(current_user).truncate(20) %> </h4>
								<p> Created <%= show_human_time(@conversation.created_at) %> </p>	
							</div>
						<% end %>
					</div>				
				</div>
				<ul class="nav navbar-nav navbar-right main-app-show-header pull-right display_inline">
					<% if(@conversation.can_user_add_participants(current_user)) %>
						<li>
							<%= link_to new_conversation_path(conversation_id: @conversation.id) do %>
								<i class="material-icons">&#xE7FE;</i>
							<% end %>
						</li>
						
						<li>
							<a href="javascript:void(0)">
								<i class="material-icons attachment-icon" id="attach-icon">&#xE226;</i>
							</a>
						</li>

					<% end %>
					
					<li class="dot-menu-show dropdownToggle"><span id="dropdownToggle"></span></li>
				</ul>
				<ul class="dropdownMenu">
					<% if(user_signed_in?) %>
						<li class="text-center">
							<%= link_to user_path(current_user) do %>
								<img src="<%= @current_user.profile_picture.media.url(:thumb) %>" class="img-circle img-sm">
							<% end %>
						</li>
						<li class="text-center">
							<%= link_to user_path(current_user) do %>
								<span>My Profile</span>
							<% end %>
						</li>
						<li class="text-center">
							<%= link_to "Logout", destroy_user_session_path, method: :delete %>
						</li>
						
					<% end %>

					
				</ul>
				
			</div>
			<div class="chat-show-tabs-upper-div ">
				<ul class="nav nav-tabs main-app-tabs chat-show-tabs" role="tablist" id="tablist">
					<% if(@conversation.can_user_view_messages(current_user)) %>
						<li class="active">
							<a data-toggle="tab" href="#all-Messages" data-message-category-input-id="#Messages-message-category-input">Messages</a>
						</li>
						<li>
							<a data-toggle="tab" href="#all-Media" data-message-category-input-id="#Media-message-category-input">Media</a>
						</li>
						<% if(!@conversation.message_categories.blank?) %>
							<% @conversation.message_categories.split(", ").each do |category| %>
								<li>								
									<a data-toggle="tab" href="#all-<%=category%>" data-message-category-input-id="#<%= category %>-message-category-input"><%= category %></a>
								</li>
							<% end %>
						<% end %>
					<% end %>
					<% if(@conversation.can_user_view_messages(current_user)) %>
						<% active_class = "" %>
					<% else %>
						<% active_class = "active" %>
					<% end %>
					<li class="<%=active_class%>">
						<a data-toggle="tab" href="#all-Chat_Request" data-message-category-input-id="#Chat_Request-message-category-input">Chat Requests</a>
					</li>

					<% if(@conversation.can_user_view_messages(current_user)) %>
						<li class="custom-events"><a data-toggle="tab" href="#all-custom-events"><span><i class="material-icons">&#xE145;</i></span><span>New Category</span></a></li>
					<% end %>
					
				</ul>	
			</div>
		</nav>
		<div class="chat-show swipe-area-show">
			<div class="container-width" style="flex:1;">
					
				<div class="col-lg-12">
					<div class="panel">        	
						<div class="tab-content tab-content-show pad-all">
							<% if(@conversation.can_user_view_messages(current_user)) %>
								<div id="all-Messages" class="tab-pane active">
									<button type="button" class="btn btn-load-message load-earlier-messages-button" data-message-category="Messages"> Load Earlier Messages </button>
									<ul class="list-unstyled media-block messages Messages-category-messages">

										<% if(!@Messages_category_messages.blank?) %>
											<% @Messages_category_messages.each do |message| %>
												<%= render partial: "messages/message", locals: {conversation: @conversation, message: message} %>
											<% end %>
										<% end %>

									</ul>
								</div>
								<div id="all-Media" class="tab-pane">
									<button type="button" class="btn btn-load-message load-earlier-messages-button"data-message-category="Media"> Load Earlier Media </button>
									<div class="clearfix"></div>
									<ul class="list-unstyled media-block messages Media-category-messages">

										<% if(!@Media_category_messages.blank?) %>
											<% @Media_category_messages.each do |message| %>
												<%= render partial: "messages/message", locals: {conversation: @conversation, message: message} %>
											<% end %>
										<% end %>

									</ul>
								</div>

								<% if(!@conversation.message_categories.blank?) %>

									<% @conversation.message_categories.split(", ").each do |category| %>
										<div id="all-<%= category %>" class="tab-pane">
											<button type="button" class="btn btn-load-message load-earlier-messages-button" data-message-category="<%= category %>"> Load Earlier <%= category %> </button>
											<ul class="list-unstyled media-block messages <%= category %>-category-messages">
												<% category_messages = instance_variable_get("@" + category + "_messages") %>
												<% if(!category_messages.blank?) %>
													<% category_messages.each do |message| %>
														<%= render partial: "messages/message", locals: {conversation: @conversation, message: message} %>
													<% end %>
												<% end %>
												
											</ul>
										</div>
									<% end %>
								<% end  %>

							<% end %>

							<% if(@conversation.can_user_view_messages(current_user)) %>
								<% active_class = "" %>
							<% else %>
								<% active_class = "active" %>
							<% end %>

							<div id="all-Chat_Request" class="tab-pane <%=active_class %>">
								<button type="button" class="btn btn-load-message load-earlier-messages-button" data-message-category="Chat_Request"> Load Earlier Requests </button>
								<ul class="list-unstyled media-block messages Chat_Request-category-messages">

									<% if(!@Chat_Request_messages.blank?) %>
										<% @Chat_Request_messages.each do |message| %>
											<%= render partial: "messages/message", locals: {conversation: @conversation, message: message} %>
										<% end %>
									<% end %>

								</ul>
							</div>

							<% if(@conversation.can_user_view_messages(current_user)) %>
								<div id="all-custom-events" class="tab-pane">
									<div class="row">
										<%= form_tag add_message_category_conversation_path(@conversation), method: :post, remote: true do %>
											<div class="col-xs-9">
												<div class="form-group">
													<%= text_field_tag :message_category, nil, placeholder: "Category Name", required: true, class: "message-category form-control" %>
												</div>
											</div>
											<div class="col-xs-3">
												<%= submit_tag :Add, class:"btn btn-success-custom btn-block new-category-name" %>
											</div>
										<% end %>
									</div>
									<h4 class="text-muted">Remove Categories</h4>
									<ul class="list-inline append-categories-tab-content">
										<% if(!@conversation.message_categories.blank?) %>
											<% @conversation.message_categories.split(", ").each do |category| %>												
												<li class="<%= category %>-Message-category-remove-link-li">													
													<%= link_to delete_message_category_conversation_path(@conversation, message_category: category), method: :delete,id:"#{category}-new-category-name", remote: true do %>
														<%= button_tag :Delete, class:"btn btn-success-custom btn-block new-category-name" do %>
															<span><%= category %> </span>
															<span class="close-icon">&times;</span>
														<% end %>
													<% end %>
												</li>												
											<% end %>
										<% end %>
									</ul>
								</div>
							<% end %>
							
						</div>	
						<div class="panel-footer">

							<div class="row">
								<% if(@conversation.can_user_send_message(current_user)) %>
					
									<%= form_tag conversation_messages_path(@conversation), id: "message-form", method: :post, remote: true, "autocomplete"=>"off" do %>
										<ul class="list-inline attachment-toggle-show" id="attachment-toggle-show">
											<li id="Image-attachment-li">
												<div class="inner-list">
													<label for="Image-attachment-category-input" class="radio attached-events"><input type="radio" id="Image-attachment-category-input" name="attachment_category" value="Image"><i class="material-icons">&#xE432;</i><br><span>Image</span></label>
												</div>
											</li>
											<li id="Video-attachment-li">
												<div class="inner-list">
													<label for="Video-attachment-category-input" class="radio attached-events"><input type="radio" id="Image-attachment-category-input" name="attachment_category" value="Video"><i class="material-icons">&#xE04A;</i><br><span>Video</span></label>
												</div>
											</li>
											<li id="Link-attachment-li">
												<div class="inner-list">
													<label for="Link-attachment-category-input" class="radio attached-events"><input type="radio" id="Link-attachment-category-input" name="attachment_category" value="Link"><i class="material-icons">&#xE157;</i><br><span>Link</span></label>
												</div>
											</li>
											<% if(!@conversation.message_categories.blank?) %>
												<% @conversation.message_categories.split(", ").each do |category| %>
													<li id="<%= category %>-attachment-li">
														<div class="inner-list">
															<label for="<%= category %>-attachment-category-input" class="attached-events radio">
																<input type="radio" id="<%= category %>-attachment-category-input" name="attachment_category" value="<%= category %>">
																<i class="material-icons">&#xE80C;</i>
																<br>
																<span><%= category %></span>													
															</label>
														</div>
													</li>
												<% end %>
											<% end %>
											
												<li class="attachment-custom-label">
													<div class="inner-list">
														<label for="custom-label" class="add-attached-events radio"><i class="material-icons">&#xE145;</i><br><span>New Category</span></label>
													</div>
												</li>
											
										</ul>
										<div style="display: none" class="message-categories-div">
											<%= radio_button_tag :message_category, :Messages, true, id: "Messages-message-category-input" %>
											<%= radio_button_tag :message_category, :Media, false, id: "Media-message-category-input" %>
											<% if(!@conversation.message_categories.blank?) %>
												<% @conversation.message_categories.split(", ").each do |category| %>
													<%= radio_button_tag :message_category, category, false, id: "#{category}-message-category-input" %>
												<% end %>
											<% end %>
										</div>
										<div class="col-xs-9">
											<label class="file-label" for="conversation-chat-image">
												<span><i class="material-icons chat-icon-upload">&#xE439;</i></span>
												<%= file_field_tag "attached_files[]",:id=>"conversation-chat-image", :class=>"custom-file-input", multiple: true, onchange: "fileChanged(this);" %>	
											</label>
											<%= text_field_tag :content, nil, autocomplete: false, placeholder: "Type your message",:class=> "form-control chat-input",  id: "new-message-text-field" , :required=> false, "autocomplete"=>"off" %>	
										</div>
										
										<div class="col-xs-3">
											<button class="btn btn-success-custom btn-block" type="submit" data-disable-with="Sending">Send</button>
										</div>
									<% end %>
								<% else %>
									<% if(@conversation.can_user_send_request(current_user)) %>
										<%= form_tag send_request_conversation_path(@conversation), id: "request-message-form", method: :post, remote: true, "autocomplete"=>"off" do %>
											
											<div class="col-xs-9">
												<%= text_field_tag :request_message, nil, autocomplete: false, placeholder: "Send upto 3 requests",:class=> "form-control chat-input",  id: "request-new-message-text-field" , :required=> true, "autocomplete"=>"off" %>	
											</div>											
											<div class="col-xs-3">
												<button class="btn btn-success-custom btn-block" type="submit" data-disable-with="Sending">Send Request</button>
											</div>
										<% end %>
										
									<% end %>
									<p style="text-align: center;">You can not post messages in this conversation.</p>
								<% end %>
								
							</div>
						</div>
					</div>	
				</div>
			</div>
		</div>
	</div>	

	<script>
		$(document).one("turbolinks:load", function(){
			App.scrollToBottomOfPage();
		});
		

		if(!App.isChannelSubscribed("ConversationsChannel", {conversation_id: <%= @conversation.id %>})){
			App.subscribe_to("ConversationsChannel", {conversation_id: <%= @conversation.id %>});
		}

		var pageNo = 2;
		var resultLoaded = {};
		$('.load-earlier-messages-button').click(function(event){
			
			message_category = $(this).attr("data-message-category");
			
			resultLoaded[message_category] = true;
			if(resultLoaded && resultLoaded[message_category] == true){
				
				resultLoaded[message_category] = false;
				
				$.ajax({
					url: "/conversations/<%= @conversation.id %>.js?message_category=" + message_category + "&page="+ pageNo,  
					type: "GET",
					beforeSend: function(data) {
						var csfrToken = $("meta[name='csrf-token']").attr("content");
						data.setRequestHeader('X-CSRF-Token', csfrToken);
					},
					success: function(data) {
						if(data.trim().length == 0) {
							resultLoaded[message_category] = false;
						} else {
							var messagesDivClass = "." + message_category + "-category-messages";
							var messagesDiv = $(messagesDivClass);
							var lastMessageDiv = $(messagesDiv).find(".message").last();
							var curOffset = lastMessageDiv.offset().top - $(document).scrollTop();
							messagesDiv.prepend(data);
							$(document).scrollTop(lastMessageDiv.offset().top-curOffset);
							resultLoaded[message_category] = true;
							pageNo++;
						}
					}
				});
			} else {
				
			}
		
		});

		<% if((@conversation.is_custom_group == false) or (current_user.role != "Student" and current_user.role != "Parent")) %>
			$("#message-form").on("submit", function(e){
				e.preventDefault();
				var submitForm = false;
				
				files = $('.custom-file-input')[0].files;
				if(files.length >= 1){
					var reader = new FileReader();
					reader.onload = function(file) {
										
						var fileType = file.target.result.split(";")[0].split(":")[1];

						var fileMarkup;
						
						if(fileType.split('/')[0] == "video"){
							
							fileMarkup = [ '<video width="200" height="200" controls class="video-js vjs-default-skin">',
		  										'<source src="', file.target.result, '" type="video/' + fileType.split('/')[1] +'" >',
		  										
		  										'Your browser does not support the video tag.',
											'</video>'].join('');

						}

						if(fileType.split('/')[0] == "image"){
							fileMarkup = ['<img  height="200" width = "200" src=', file.target.result, '>'].join('');
						}


						
						messageMarkup = [
							'<li class="mar-btm message-div message cretor-message temp-message" >',
								'<div class="media-right message-participant-profile-picture">',
									'<img src="<%= current_user.profile_picture.media.url(:thumb) %>" class="media-object img-circle img-sm" >',
								'</div>',
								'<div class="media-body message-body pad-hor speech-right">',
									'<div class="speech">',
										'<a href="#" class="media-heading"> <%= current_user.first_name %> </a>',
										'<p>', fileMarkup, '</p>',
										
										'<span class="checkmark" style="display:inline-block;"></span>',

									
									'</div>',
								'</div>',
							'</li>'	
						
						];
						
						$(".Messages-category-messages").append(messageMarkup.join(''));
						if($('#all-Messages').attr("class").indexOf("active") <= 0){
							$(".Media-category-messages").append(messageMarkup.join(''));
							if($('#all-Media').attr("class").indexOf("active") <= 0){
								$($('li.active a').attr('href')).find('.messages').append(messageMarkup.join(''));		
							}
							
						}
						
						App.scrollToBottomOfPage();
						
					}

					$.each( files, function( i, file ) {
						reader.readAsDataURL(file);
					});
					
					submitForm = true;
				}
				
				var message = $("#new-message-text-field").val();
				var trimedMessage = message.trim();		
				
				if(trimedMessage.length >= 1){
					
					messageMarkup = [
						'<li class="mar-btm message-div message cretor-message temp-message" >',
							'<div class="media-right message-participant-profile-picture">',
								'<img src="<%= current_user.profile_picture.media.url(:thumb) %>" class="media-object img-circle img-sm" >',
							'</div>',
							'<div class="media-body message-body pad-hor speech-right">',
								'<div class="speech">',
									'<a href="#" class="media-heading"> <%= current_user.first_name %> </a>',
									'<p>', message, '</p>',
									
									'<span class="checkmark" style="display:inline-block;"></span>',

								
								'</div>',
							'</div>',
						'</li>'
							
						];
							
					$(".Messages-category-messages").append(messageMarkup.join(''));
					if($('#all-Messages').attr("class").indexOf("active") <= 0){
						$($('li.active a').attr('href')).find('.messages').append(messageMarkup.join(''));	
					}			
					
					
					App.scrollToBottomOfPage();
				
					
					submitForm = true;
					
				}
				
				return submitForm;
			});

			function fileChanged(event){
				
				var files = event.files;
				
				if(files.length > 0){
					$("#message-form").submit();
					
				}		
			}

		<% end %>
		
	</script>

<% end %>

